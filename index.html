<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class Routine</title>
  <!-- PWA: manifest and theme color -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/icons/icon-192.svg">
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Simple body font for better aesthetics */
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
  <!-- Load Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">

  <div class="min-h-screen p-6 flex flex-col items-center">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Class Routine</h1>

    <!-- Day selection buttons will be rendered here -->
    <div id="day-buttons-container" class="flex flex-wrap justify-center gap-3 mb-8"></div>

    <!-- Buttons: install + open modal -->
    <div class="w-full max-w-2xl mb-8 flex justify-end items-center gap-3">
      <button id="install-btn" class="hidden bg-green-600 text-white rounded-lg px-3 py-2 text-sm hover:bg-green-700 transition" title="Install app">Install</button>
      <button id="open-modal-btn" class="bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:bg-blue-700 transition" title="Add new class">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
      </button>
    </div>

    <div class="w-full max-w-2xl">
      <h2 id="classes-title" class="text-xl font-semibold text-gray-700 mb-3"></h2>
      <!-- Class list will be rendered here -->
      <div id="class-list-container" class="grid gap-4"></div>
    </div>
  </div>

  <!-- Modal container -->
  <div id="modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
    <div id="modal-content" class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-2xl">
      <!-- Modal Header -->
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-800">Add / Update Class</h2>
        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Form inside modal -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <input
          type="text"
          id="course-input"
          placeholder="Course Name"
          class="border rounded-lg px-3 py-2 text-sm w-full"
        />
        <input
          type="text"
          id="code-input"
          placeholder="Course Code"
          class="border rounded-lg px-3 py-2 text-sm w-full"
        />
        <select id="day-select" class="border rounded-lg px-3 py-2 text-sm w-full">
          <!-- Day options will be rendered here -->
        </select>
        <select id="type-select" class="border rounded-lg px-3 py-2 text-sm w-full">
          <option>Theory</option>
          <option>Lab</option>
        </select>
        <input
          type="text"
          id="time-input"
          placeholder="Time (e.g., 1:00 PM - 2:30 PM)"
          class="border rounded-lg px-3 py-2 text-sm w-full"
        />
        <input
          type="text"
          id="room-input"
          placeholder="Room"
          class="border rounded-lg px-3 py-2 text-sm w-full"
        />
        <button
          id="add-button"
          class="sm:col-span-2 bg-blue-600 text-white rounded-lg py-2 text-sm hover:bg-blue-700 transition"
        >
          Add / Update Class
        </button>
      </div>
    </div>
  </div>

  <script>
    // --- STATE & INITIAL DATA ---

    let initialSchedule = [
      {
        course: 'Digital Logic and Circuits [K]',
        code: '01876',
        sessions: [
          { day: 'Sunday', type: 'Theory', time: '1:00 PM - 2:30 PM', room: 'DS0504' },
          { day: 'Tuesday', type: 'Theory', time: '1:00 PM - 2:30 PM', room: 'DS0504' }
        ]
      },
      {
        course: 'Web Technologies [G]',
        code: '01530',
        sessions: [
          { day: 'Monday', type: 'Theory', time: '3:00 PM - 5:00 PM', room: '9402' },
          { day: 'Wednesday', type: 'Lab', time: '3:00 PM - 5:20 PM', room: 'DS0104' }
        ]
      },
      {
        course: 'Compiler Design [G]',
        code: '00994',
        sessions: [
          { day: 'Monday', type: 'Theory', time: '12:40 PM - 2:40 PM', room: '9406' },
          { day: 'Wednesday', type: 'Lab', time: '12:40 PM - 3:00 PM', room: 'DS0203' }
        ]
      },
      {
        course: 'Chemistry [G]',
        code: '00395',
        sessions: [
          { day: 'Tuesday', type: 'Theory', time: '3:00 PM - 5:00 PM', room: '9212' },
          { day: 'Sunday', type: 'Lab', time: '3:00 PM - 5:20 PM', room: 'DE0201' }
        ]
      }
    ];

    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday'];
    const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
    
    // Check if today is one of the schedule days, otherwise default to the first
    let selectedDay = days.includes(today) ? today : days[0];
    
    // Use 'let' as schedule can be modified
    let schedule = JSON.parse(JSON.stringify(initialSchedule)); // Deep copy
    
    let newClass = {
      course: '',
      code: '',
      day: days[0],
      type: 'Theory',
      time: '',
      room: ''
    };

    // --- DOM ELEMENT REFERENCES ---

    const dayButtonsContainer = document.getElementById('day-buttons-container');
    const classListContainer = document.getElementById('class-list-container');
    const classesTitle = document.getElementById('classes-title');
    const addButton = document.getElementById('add-button');

    // Modal elements
    const openModalBtn = document.getElementById('open-modal-btn');
    const modalOverlay = document.getElementById('modal-overlay');
    const closeModalBtn = document.getElementById('close-modal-btn');
    
    // Form Inputs
    const courseInput = document.getElementById('course-input');
    const codeInput = document.getElementById('code-input');
    const daySelect = document.getElementById('day-select');
    const typeSelect = document.getElementById('type-select');
    const timeInput = document.getElementById('time-input');
    const roomInput = document.getElementById('room-input');

    // --- MODAL FUNCTIONS ---

    function showModal() {
        modalOverlay.classList.remove('hidden');
    }

    function hideModal() {
        modalOverlay.classList.add('hidden');
    }

    // --- RENDER FUNCTIONS ---

    /**
     * Main function to re-render the dynamic parts of the UI
     */
    function renderApp() {
      renderDayButtons();
      renderDayOptions();
      renderClassList();
      updateNewClassInputs();
    }

    /**
     * Renders the day selection buttons
     */
    function renderDayButtons() {
      dayButtonsContainer.innerHTML = ''; // Clear existing buttons
      days.forEach(day => {
        const button = document.createElement('button');
        button.textContent = day;
        button.className = `px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 ${
          selectedDay === day
            ? 'bg-blue-600 text-white shadow-md'
            : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-100'
        }`;
        
        button.onclick = () => {
          selectedDay = day;
          renderApp();
        };
        dayButtonsContainer.appendChild(button);
      });
    }

    /**
     * Renders the options for the 'Add Class' day dropdown
     */
    function renderDayOptions() {
        daySelect.innerHTML = ''; // Clear existing options
        days.forEach(d => {
            const option = document.createElement('option');
            option.value = d;
            option.textContent = d;
            if (d === newClass.day) {
                option.selected = true;
            }
            daySelect.appendChild(option);
        });
    }

    /**
     * Renders the list of classes for the selected day
     */
    function renderClassList() {
      classesTitle.textContent = `${selectedDay}'s Classes`;
      classListContainer.innerHTML = ''; // Clear existing list

      const dayClasses = schedule.flatMap((course) =>
        course.sessions
          .filter((s) => s.day === selectedDay)
          .map((s) => ({ ...s, course: course.course, code: course.code }))
      );

      if (dayClasses.length === 0) {
        classListContainer.innerHTML = '<p class="text-gray-500 text-center">No classes today ðŸŽ‰</p>';
        return;
      }

      dayClasses.forEach((cls) => {
        const classCard = document.createElement('div');
        classCard.className = `rounded-2xl p-4 shadow-sm border flex justify-between items-center transition hover:shadow-md ${
          cls.type === 'Theory' ? 'bg-white' : 'bg-blue-50'
        }`;
        
        classCard.innerHTML = `
          <div>
            <h2 class="text-lg font-semibold text-gray-800">${cls.course}</h2>
            <p class="text-sm text-gray-500 mb-1">Code: ${cls.code}</p>
            <div class="flex flex-col sm:flex-row sm:gap-4 text-sm text-gray-700">
              <span>${cls.type}</span>
              <span>${cls.time}</span>
              <span>Room: ${cls.room}</span>
            </div>
          </div>
          <button class="remove-btn text-red-500 hover:text-red-700 text-sm font-semibold ml-4">
            Remove
          </button>
        `;
        
        // Add remove functionality
        classCard.querySelector('.remove-btn').onclick = () => {
          handleRemove(cls.code, cls.time);
        };
        
        classListContainer.appendChild(classCard);
      });
    }

    /**
     * Updates the form inputs to match the newClass state object
     */
    function updateNewClassInputs() {
        courseInput.value = newClass.course;
        codeInput.value = newClass.code;
        daySelect.value = newClass.day;
        typeSelect.value = newClass.type;
        timeInput.value = newClass.time;
        roomInput.value = newClass.room;
    }

    // --- EVENT HANDLERS & LOGIC ---

    function handleAdd() {
      // Update newClass from inputs first (in case they were typed but not blurred)
      syncNewClassFromInputs();
      
      if (!newClass.course || !newClass.code || !newClass.time || !newClass.room) {
        // You can replace this with a more graceful UI error
        console.warn("All fields are required!"); 
        return;
      }

      const existing = schedule.find((c) => c.code === newClass.code);
      
      if (existing) {
        // Add session to existing course
        existing.sessions.push({
          day: newClass.day,
          type: newClass.type,
          time: newClass.time,
          room: newClass.room
        });
      } else {
        // Add new course
        schedule.push({
          course: newClass.course,
          code: newClass.code,
          sessions: [
            {
              day: newClass.day,
              type: newClass.type,
              time: newClass.time,
              room: newClass.room
            }
          ]
        });
      }

      // Reset newClass object
      newClass = { course: '', code: '', day: days[0], type: 'Theory', time: '', room: '' };
      
      // Re-render everything
      renderApp();
      // Hide modal after adding
      hideModal();
    }

    function handleRemove(code, time) {
      schedule = schedule
        .map((c) => ({
          ...c,
          sessions: c.sessions.filter((s) => !(s.time === time && c.code === code))
        }))
        .filter((c) => c.sessions.length > 0);
      
      // Re-render
      renderApp();
    }
    
    /**
     * Syncs the newClass object with the current values in the form fields
     */
    function syncNewClassFromInputs() {
        newClass.course = courseInput.value;
        newClass.code = codeInput.value;
        newClass.day = daySelect.value;
        newClass.type = typeSelect.value;
        newClass.time = timeInput.value;
        newClass.room = roomInput.value;
    }

    // --- INITIALIZATION ---
    
    // Modal listeners
    openModalBtn.onclick = showModal;
    closeModalBtn.onclick = hideModal;
    modalOverlay.onclick = (e) => {
        // Only close if clicking on the overlay itself, not the content
        if (e.target === modalOverlay) {
            hideModal();
        }
    };

    // Attach event listeners
    addButton.onclick = handleAdd;
    
    // Add listeners to update the newClass object as the user types
    courseInput.oninput = syncNewClassFromInputs;
    codeInput.oninput = syncNewClassFromInputs;
    daySelect.onchange = syncNewClassFromInputs;
    typeSelect.onchange = syncNewClassFromInputs;
    timeInput.oninput = syncNewClassFromInputs;
    roomInput.oninput = syncNewClassFromInputs;

    // Initial render on page load
    renderApp();
    
  </script>
  <!-- PWA: register service worker and handle install prompt -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => {
            console.log('Service worker registered.', reg);
          })
          .catch(err => console.warn('SW registration failed:', err));
      });
    }

    // Handle Add to Home Screen prompt and install button
    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');

    function showInstallButton() {
      installBtn.classList.remove('hidden');
    }

    function hideInstallButton() {
      installBtn.classList.add('hidden');
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // Show install button to user
      showInstallButton();
      console.log('beforeinstallprompt fired');
    });

    // If the app is already installed (display-mode change), hide the button
    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed');
      deferredPrompt = null;
      hideInstallButton();
      try { localStorage.setItem('pwa_installed', '1'); } catch (err) {}
    });

    // If previously installed, don't show the button
    try {
      if (localStorage.getItem('pwa_installed')) {
        hideInstallButton();
      }
    } catch (err) {}

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const choiceResult = await deferredPrompt.userChoice;
      if (choiceResult.outcome === 'accepted') {
        console.log('User accepted A2HS');
      } else {
        console.log('User dismissed A2HS');
      }
      deferredPrompt = null;
      hideInstallButton();
    });

    // Optional: expose method to trigger the prompt from dev console
    window.triggerA2HS = async () => {
      if (!deferredPrompt) return console.log('No install prompt saved');
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      console.log('User choice', choice);
      deferredPrompt = null;
    };
  </script>
</body>
</html>

